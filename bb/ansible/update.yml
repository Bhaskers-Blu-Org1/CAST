#  sudo ansible-playbook -i hosts  <this.yml>

#check to see if all hosts are available--fail if not reachable
- hosts: all
  tasks:
  any_errors_fatal: true

- hosts: localhost
  tasks:
    - name: cwd
      command: pwd  
      register: pwd_info

    - debug: 
         msg: "cwd is {{pwd_info.stdout}} playbook_dir is {{playbook_dir}}" 
    - debug:
         msg: "BBRPMDIR={{BBRPMDIR}}"
    - debug:
        msg:  "CSMRPMDIR={{CSMRPMDIR}}"
    - debug:
        msg:  "BBMETADATA={{BBMETADATA}}"

#check for BB RPMDIR early before doing upgrade
- hosts: server compute launch
  tasks:
  - name: check all nodes for RPM directory
    command: ls -d  {{BBRPMDIR}} 
    register: bbrpmdir_check
    any_errors_fatal: true

- hosts: server
  tasks:
  - name: check server node for BBMETADATA 
    command: ls -d  {{BBMETADATA}} 
    any_errors_fatal: true    

#section for stopping daemons, removing RPMs, cleaning up
- hosts: localhost
  tasks:
    - debug:
         msg: stop CSM and burstbuffer
- name: Include stop of CSM        
  import_playbook: csmStop.yml 
- name: Include stop of bb       
  import_playbook: bbStop.yml
- name: Include uninstall of CSM       
  import_playbook: csmUninstall.yml  
- name: Include bb uninstall       
  import_playbook: bbUninstall.yml    

#section for installing RPMs, starting daemons
- hosts: localhost
  tasks:
    - debug:
         msg: install csm and bb
- name: Include csm install     
  import_playbook: csmInstall.yml 
  when: CSMRPMDIR is defined
- name: Include bb install      
  import_playbook: bbInstall.yml 
- name: certificate setup     
  import_playbook: certificates.yml   
- name: Include csm start     
  import_playbook: csmStart.yml 
  when: CSMRPMDIR is defined
- name: Include bb start      
  import_playbook: bbStart.yml  
   

